<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover"
    />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <title>GADG3T</title>
    <style>
      :root {
        --bg: #0d0d0d;
        --surface: #1c1c1e;
        --surface-hover: #2c2c2e;
        --text: #f5f5f7;
        --text-muted: #8e8e93;
        --accent: #0a84ff;
        --accent-dim: rgba(10, 132, 255, 0.25);
        --border: #38383a;
        --radius: 14px;
        --radius-sm: 10px;
        --safe-top: env(safe-area-inset-top);
        --safe-bottom: env(safe-area-inset-bottom);
      }

      * {
        box-sizing: border-box;
      }

      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        font-size: 17px;
        line-height: 1.45;
        color: var(--text);
        background: var(--bg);
        margin: 0;
        padding: max(16px, var(--safe-top)) 20px max(28px, var(--safe-bottom));
        min-height: 100vh;
        -webkit-tap-highlight-color: transparent;
      }

      h1 {
        font-size: 1.5rem;
        font-weight: 600;
        margin: 0 0 20px;
        color: var(--text-muted);
      }

      .card {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 18px;
        margin-bottom: 14px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.25);
      }

      .card-title {
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.06em;
        color: var(--text-muted);
        margin: 0 0 10px;
      }

      .row {
        display: flex;
        align-items: center;
        gap: 12px;
        flex-wrap: wrap;
      }
      .row-tight {
        gap: 6px;
      }
      .pu-group {
        display: flex;
        align-items: baseline;
        gap: 0;
      }
      .pu-group .counter-value {
        margin-left: -2px;
      }

      .counter-value {
        font-size: 1.25rem;
        font-weight: 600;
        min-width: 4ch;
        color: var(--text);
      }

      #pu-value {
        font: inherit;
        font-size: 1.25rem;
        font-weight: 600;
        width: 4ch;
        padding: 0;
        margin: 0;
        border: none;
        background: transparent;
        color: var(--text);
        -webkit-text-fill-color: var(--text);
        text-align: right;
      }
      #pu-value:focus {
        outline: none;
      }

      button {
        font: inherit;
        color: var(--accent);
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: var(--radius-sm);
        padding: 8px 14px;
        cursor: pointer;
        -webkit-appearance: none;
        appearance: none;
        transition:
          border-color 0.2s ease,
          opacity 0.15s ease;
      }

      button:hover {
        border-color: var(--accent);
      }
      button:active {
        opacity: 0.85;
      }

      #lunch-time {
        font: inherit;
        padding: 10px 12px;
        border: 1px solid var(--border);
        border-radius: var(--radius-sm);
        min-width: 120px;
        background: var(--bg);
        color: var(--text);
        transition: border-color 0.2s ease;
        -webkit-appearance: none;
        appearance: none;
      }
      #lunch-time:focus {
        border-color: var(--accent);
        outline: none;
      }

      .todos-input-row {
        display: flex;
        gap: 8px;
        margin-bottom: 12px;
      }

      .todos-input-row input {
        flex: 1;
        font: inherit;
        padding: 10px 12px;
        border: 1px solid var(--border);
        border-radius: var(--radius-sm);
        background: var(--bg);
        color: var(--text);
        transition: border-color 0.2s ease;
      }
      .todos-input-row input:focus {
        border-color: var(--accent);
        outline: none;
      }

      .todos-input-row input::placeholder {
        color: var(--text-muted);
      }

      .todos-input-row button {
        flex-shrink: 0;
      }

      .todo-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 0;
        border-bottom: 1px solid var(--border);
      }

      .todo-item:last-child {
        border-bottom: none;
      }

      .todo-item input[type="checkbox"] {
        width: 22px;
        height: 22px;
        flex-shrink: 0;
        accent-color: var(--accent);
      }

      .todo-item label {
        flex: 1;
        cursor: pointer;
        user-select: none;
      }

      .todo-item.done label {
        text-decoration: line-through;
        color: var(--text-muted);
      }

      .todo-item .remove {
        padding: 4px 8px;
        font-size: 0.85rem;
        color: var(--text-muted);
      }

      .view {
        display: none;
      }
      .view.active {
        display: block;
      }
      .slide-container {
        position: relative;
        overflow: hidden;
        min-height: 100vh;
      }
      .slide-container .slide-track {
        display: flex;
        width: 300%;
        min-height: 100vh;
        transition: transform 0.35s ease;
      }
      .slide-container .slide-track .view {
        width: 33.333%;
        flex-shrink: 0;
        display: block;
        min-height: 100vh;
      }
      .slide-container .slide-track.show-note {
        transform: translateX(-33.333%);
      }
      .slide-container .slide-track.show-past {
        transform: translateX(-66.666%);
      }

      .menu-title {
        font-size: 1.75rem;
        font-weight: 600;
        letter-spacing: -0.02em;
        margin: 0 0 6px;
        color: var(--text);
      }
      .menu-sub {
        color: var(--text-muted);
        font-size: 0.95rem;
        margin: 0 0 28px;
      }
      .today-section-title {
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.04em;
        color: var(--text-muted);
        margin: 0 0 8px;
      }
      .menu-item-btn {
        display: flex;
        align-items: center;
        justify-content: space-between;
        width: 100%;
        font: inherit;
        font-size: 1.05rem;
        font-weight: 500;
        color: var(--text);
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 14px 18px;
        margin-bottom: 28px;
        cursor: pointer;
        text-align: left;
        -webkit-appearance: none;
        appearance: none;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        transition:
          border-color 0.2s ease,
          background 0.2s ease;
      }
      .menu-item-btn:hover {
        background: var(--surface-hover);
        border-color: rgba(255, 255, 255, 0.08);
      }
      .menu-item-btn:active {
        opacity: 0.95;
      }
      .menu-item-chevron {
        color: var(--text);
        font-size: 1.1rem;
      }
      .menu-item-link {
        text-decoration: none;
        color: inherit;
      }
      .past-section-title {
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.04em;
        color: var(--text-muted);
        margin: 0 0 8px;
      }
      .past-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }
      .past-list a {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 14px 18px;
        color: var(--text);
        text-decoration: none;
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        margin-bottom: 10px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        transition:
          border-color 0.2s ease,
          background 0.2s ease;
      }
      .past-list a:hover {
        background: var(--surface-hover);
        border-color: rgba(255, 255, 255, 0.08);
      }
      .past-list a:active {
        opacity: 0.95;
      }
      .past-list a::after {
        content: "›";
        font-size: 1.1rem;
        color: var(--text);
      }
      .back-link {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        color: var(--accent);
        text-decoration: none;
        font-size: 0.95rem;
        margin-bottom: 16px;
        transition: opacity 0.15s ease;
      }
      .back-link:hover {
        opacity: 0.9;
      }
      .back-link:active {
        opacity: 0.8;
      }

      .past-trackers-view .past-trackers-nav {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 20px;
      }
      .past-trackers-view .past-trackers-nav .back-link {
        margin-bottom: 0;
      }
      .past-trackers-view .past-trackers-title {
        font-size: 1.25rem;
        font-weight: 600;
        margin: 0;
        color: var(--text-muted);
      }
      .past-trackers-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }
      .past-tracker-card {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px 18px;
        margin-bottom: 10px;
        color: var(--text);
        text-decoration: none;
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        transition: border-color 0.2s ease, background 0.2s ease;
      }
      .past-tracker-card:hover {
        background: var(--surface-hover);
        border-color: rgba(255, 255, 255, 0.08);
      }
      .past-tracker-card:active {
        opacity: 0.95;
      }
      .past-tracker-card-content {
        flex: 1;
        min-width: 0;
      }
      .past-tracker-card-date {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--text);
        margin: 0 0 6px;
      }
      .past-tracker-card-metrics {
        font-size: 0.9rem;
        color: var(--text-muted);
        margin: 0;
      }
      .past-tracker-card-chevron {
        flex-shrink: 0;
        font-size: 1.1rem;
        color: var(--text);
        margin-left: 12px;
      }

      .menu-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 8px;
      }
      .menu-header .menu-title {
        margin: 0;
      }
      .menu-options-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
        padding: 0;
        border: none;
        background: none;
        color: var(--text-muted);
        text-decoration: none;
        border-radius: 10px;
        transition:
          color 0.2s ease,
          background 0.2s ease;
      }
      .menu-options-btn:hover {
        color: var(--text);
        background: var(--surface);
      }
      .menu-options-btn svg {
        width: 22px;
        height: 22px;
      }

      /* Note view nav */
      .note-nav {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 8px;
      }
      .note-back {
        margin-bottom: 0;
        font-size: 1.25rem;
        padding: 4px 0;
      }
      .note-title {
        font-size: 1.25rem;
        font-weight: 600;
        margin: 0;
        color: var(--text-muted);
      }
      .note-date {
        margin: 0 0 20px;
        font-size: 1rem;
        font-weight: 500;
        color: var(--text-muted);
      }

      /* 2-column counters */
      .counters-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-bottom: 14px;
      }
      .counter-card {
        margin-bottom: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 16px 12px;
      }
      .counter-card .card-title {
        margin-bottom: 8px;
      }
      .counter-big-value {
        font-size: 2rem;
        font-weight: 600;
        color: var(--text);
        margin: 8px 0 12px;
        min-height: 2.25rem;
      }
      .counter-buttons {
        display: flex;
        gap: 12px;
        justify-content: center;
        width: 100%;
      }
      .counter-btn {
        flex: 1;
        max-width: 80px;
        padding: 10px;
        font-size: 1.25rem;
        color: var(--text);
        border-color: var(--border);
      }
      .counter-btn:hover {
        border-color: var(--text-muted);
      }
      .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        border: 0;
      }

      /* Lunch full-width */
      .lunch-card {
        margin-bottom: 14px;
      }
      .lunch-input-wrap {
        display: flex;
        align-items: center;
        gap: 10px;
        width: 100%;
      }
      .lunch-time-input {
        flex: 1;
        min-width: 0;
        padding: 12px 14px;
        font-size: 1rem;
      }
      .lunch-time-icon {
        flex-shrink: 0;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        color: var(--text-muted);
      }
      .lunch-time-icon svg {
        display: block;
      }

      /* TODO: add row above list, + on right */
      .todo-card .card-title {
        margin-bottom: 12px;
      }
      .todo-card .todos-input-row {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 14px;
      }
      .todo-card .todos-input-row input {
        flex: 1;
        min-width: 0;
        font: inherit;
        padding: 10px 12px;
        border: 1px solid var(--border);
        border-radius: var(--radius-sm);
        background: var(--bg);
        color: var(--text);
      }
      .todo-card .todos-input-row input:focus {
        border-color: var(--accent);
        outline: none;
      }
      .todo-card .todos-input-row input::placeholder {
        color: var(--text-muted);
      }
      .todo-add-btn {
        width: 40px;
        height: 40px;
        padding: 0;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        line-height: 1;
        color: var(--text);
        background: var(--surface-hover);
        border: 1px solid var(--border);
        flex-shrink: 0;
      }
      .todo-add-btn:hover {
        border-color: var(--text-muted);
      }
      .todo-list {
        border-top: 1px solid var(--border);
        padding-top: 8px;
      }
      .todo-row {
        position: relative;
        overflow: hidden;
        margin-bottom: 2px;
        border-radius: var(--radius-sm);
        background: var(--surface);
        transition: transform 0.25s ease-out;
      }
      .todo-row:last-child {
        margin-bottom: 0;
      }
      .todo-row-delete {
        position: absolute;
        right: -80px;
        top: 0;
        bottom: 0;
        width: 80px;
        pointer-events: none;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #c62828;
        border: none;
        border-radius: 0;
        color: #fff;
        font: inherit;
        font-weight: 600;
        font-size: 0.95rem;
        cursor: pointer;
        -webkit-appearance: none;
        appearance: none;
        padding: 0;
        flex-shrink: 0;
        z-index: 0;
        transition: right 300ms ease;
      }
      .todo-row.reveal-delete .todo-row-delete {
        right: 0;
        pointer-events: auto;
      }
      .todo-row-delete:active {
        background: #b71c1c;
      }
      .todo-item {
        position: relative;
        z-index: 1;
        width: 100%;
        min-width: 100%;
        box-sizing: border-box;
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 10px;
        border-radius: var(--radius-sm);
        background: var(--surface);
        min-height: 48px;
        transition: transform 300ms ease;
        will-change: transform;
      }
      .todo-row.reveal-delete .todo-item {
        transform: translateX(-80px);
      }
      .todo-item .todo-check-label {
        display: flex;
        align-items: center;
        gap: 12px;
        flex: 1;
        min-width: 0;
        cursor: pointer;
        user-select: none;
      }
      .todo-item input[type="checkbox"] {
        position: absolute;
        opacity: 0;
        width: 0;
        height: 0;
        margin: 0;
        pointer-events: none;
      }
      .todo-check-visual {
        width: 22px;
        height: 22px;
        flex-shrink: 0;
        border-radius: 50%;
        border: 2px solid var(--text-muted);
        background: var(--surface);
        transition:
          background 0.2s ease,
          border-color 0.2s ease;
      }
      .todo-item input:checked + .todo-check-visual {
        background: #fff;
        border-color: #fff;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2338383a' stroke-width='2.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M5 13l4 4L19 7'/%3E%3C/svg%3E");
        background-size: 14px 14px;
        background-position: center;
        background-repeat: no-repeat;
      }
      .todo-item .todo-label-text {
        flex: 1;
        min-width: 0;
      }
      .todo-item.done .todo-label-text {
        text-decoration: line-through;
        color: var(--text-muted);
      }
      .todo-drag-handle {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 6px;
        margin: -6px -6px -6px 0;
        color: var(--text-muted);
        cursor: grab;
        -webkit-tap-highlight-color: transparent;
        touch-action: none;
      }
      .todo-drag-handle:active {
        cursor: grabbing;
      }
      .todo-drag-handle svg {
        width: 20px;
        height: 20px;
        display: block;
      }
      .todo-row.drag-over .todo-item {
        opacity: 0.6;
      }
      .todo-row.todo-row-dragging {
        opacity: 0.85;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
      }
      .todo-row.todo-row-dragging .todo-item {
        background: var(--surface-hover);
      }

      .notes-card {
        margin-bottom: 14px;
      }
      .notes-card .card-title {
        margin-bottom: 10px;
      }
      .notes-input {
        width: 100%;
        min-height: 100px;
        font: inherit;
        font-size: 1rem;
        line-height: 1.5;
        padding: 12px 14px;
        border: 1px solid var(--border);
        border-radius: var(--radius-sm);
        background: var(--bg);
        color: var(--text);
        resize: vertical;
        -webkit-appearance: none;
        appearance: none;
        box-sizing: border-box;
      }
      .notes-input:focus {
        border-color: var(--accent);
        outline: none;
      }
      .notes-input::placeholder {
        color: var(--text-muted);
      }
    </style>
  </head>
  <body>
    <div id="slide-container" class="slide-container">
      <div id="slide-track" class="slide-track">
        <div id="menu-view" class="view">
          <div class="menu-header">
            <h1 class="menu-title">GADG3T</h1>
            <a
              href="#options"
              class="menu-options-btn"
              id="menu-options"
              aria-label="Settings"
            >
              <svg
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <circle cx="12" cy="12" r="3" />
                <path
                  d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"
                />
              </svg>
            </a>
          </div>
          <div class="today-section-title">TRACK3RS</div>
          <button type="button" class="menu-item-btn" id="btn-today">
            <span>Today's TRACK3R</span>
            <span class="menu-item-chevron">›</span>
          </button>
          <a href="#past" class="menu-item-btn menu-item-link">
            <span>Past TRACK3RS</span>
            <span class="menu-item-chevron">›</span>
          </a>
        </div>

        <div id="note-view" class="view">
          <header class="note-nav">
            <a href="#" class="back-link note-back" id="back-to-menu">←</a>
            <h1 class="note-title">Daily Tracker</h1>
          </header>
          <p class="note-date" id="today-date"></p>

          <div class="counters-row">
            <div class="card counter-card">
              <div class="card-title">SR Counter</div>
              <div class="counter-big-value" id="sr-display">0</div>
              <div class="counter-buttons">
                <button
                  type="button"
                  class="counter-btn"
                  id="sr-decrement"
                  aria-label="Decrement SR"
                >
                  −
                </button>
                <button
                  type="button"
                  class="counter-btn"
                  id="sr-increment"
                  aria-label="Increment SR"
                >
                  +
                </button>
              </div>
            </div>
            <div class="card counter-card">
              <div class="card-title">PU Counter</div>
              <div class="counter-big-value" id="pu-display">0</div>
              <input
                type="number"
                id="pu-value"
                min="0"
                max="100"
                value="0"
                aria-label="PU count"
                class="sr-only"
              />
              <div class="counter-buttons">
                <button
                  type="button"
                  class="counter-btn"
                  id="pu-decrement"
                  aria-label="Decrement PU"
                >
                  −
                </button>
                <button
                  type="button"
                  class="counter-btn"
                  id="pu-increment"
                  aria-label="Increment PU"
                >
                  +
                </button>
              </div>
            </div>
          </div>

          <div class="card lunch-card">
            <div class="card-title">Lunch clock out time</div>
            <div class="lunch-input-wrap">
              <input
                type="time"
                id="lunch-time"
                class="lunch-time-input"
                aria-label="Lunch clock out time"
              />
              <span class="lunch-time-icon" aria-hidden="true">
                <svg
                  width="20"
                  height="20"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <circle cx="12" cy="12" r="10" />
                  <path d="M12 6v6l4 2" />
                </svg>
              </span>
            </div>
          </div>

          <div class="card todo-card">
            <div class="card-title">TODO</div>
            <div class="todos-input-row">
              <input
                type="text"
                id="todo-input"
                placeholder="Add new todo..."
                enterkeyhint="done"
              />
              <button
                type="button"
                class="todo-add-btn"
                id="todo-add"
                aria-label="Add todo"
              >
                +
              </button>
            </div>
            <div id="todo-list" class="todo-list"></div>
          </div>

          <div class="card notes-card">
            <div class="card-title">Notes</div>
            <textarea id="notes-input" class="notes-input" rows="4"></textarea>
          </div>
        </div>

        <div id="past-view" class="view past-trackers-view">
          <header class="past-trackers-nav">
            <a href="#menu" class="back-link note-back">←</a>
            <h1 class="past-trackers-title">Past TRACK3RS</h1>
          </header>
          <ul id="past-trackers-list" class="past-trackers-list"></ul>
        </div>
      </div>
    </div>

    <div id="options-view" class="view">
      <a href="#" class="back-link" id="back-from-options">← Back to menu</a>
      <h1 class="menu-title">Settings</h1>
      <p class="menu-sub">
        Customize your tracker. More settings coming later.
      </p>
      <div class="card">
        <div class="card-title">SR Counter</div>
        <p
          style="margin: 0 0 12px; font-size: 0.95rem; color: var(--text-muted)"
        >
          The SR counter increases by 1 each day. Reset it here to start the
          streak over (today becomes Day 0).
        </p>
        <button type="button" id="reset-sr">Reset SR Counter</button>
      </div>
    </div>

    <script>
      const STORAGE_KEY = "dailyTracker";

      function todayKey() {
        const d = new Date();
        return (
          d.getFullYear() +
          "-" +
          String(d.getMonth() + 1).padStart(2, "0") +
          "-" +
          String(d.getDate()).padStart(2, "0")
        );
      }

      function formatDisplayDate(isoDate) {
        const [y, m, d] = isoDate.split("-").map(Number);
        return (
          String(m).padStart(2, "0") +
          "/" +
          String(d).padStart(2, "0") +
          "/" +
          y
        );
      }

      function loadAll() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          return raw ? JSON.parse(raw) : {};
        } catch {
          return {};
        }
      }

      function saveAll(data) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      }

      function getDayData(dateKey) {
        const data = loadAll();
        if (!data[dateKey]) {
          data[dateKey] = {
            srCounter: 0,
            puCounter: 0,
            lunch: "",
            todos: [],
            notes: "",
          };
          const prevKey = prevDateKey(dateKey);
          if (prevKey && data[prevKey]) {
            data[dateKey].srCounter = (data[prevKey].srCounter || 0) + 1;
          } else {
            data[dateKey].srCounter = 1;
          }
        }
        return data[dateKey];
      }

      function prevDateKey(dateKey) {
        const d = new Date(dateKey + "T12:00:00");
        d.setDate(d.getDate() - 1);
        const y = d.getFullYear(),
          m = d.getMonth() + 1,
          day = d.getDate();
        return (
          y +
          "-" +
          String(m).padStart(2, "0") +
          "-" +
          String(day).padStart(2, "0")
        );
      }

      function persistDay(dateKey, dayData) {
        const data = loadAll();
        data[dateKey] = {
          srCounter: dayData.srCounter ?? 0,
          puCounter: dayData.puCounter ?? 0,
          lunch: dayData.lunch || "",
          todos: Array.isArray(dayData.todos) ? dayData.todos : [],
          notes: dayData.notes || "",
        };
        saveAll(data);
      }

      let currentKey = todayKey();
      let state = getDayData(currentKey);
      var todoReorderDragging = false;

      function getRoute() {
        const hash = (location.hash || "").replace(/^#/, "");
        if (hash === "options") return { view: "options" };
        if (hash === "past") return { view: "past" };
        if (hash === "note") return { view: "note", dateKey: todayKey() };
        const m = hash.match(/^note\/(\d{4}-\d{2}-\d{2})$/);
        if (m) return { view: "note", dateKey: m[1] };
        return { view: "menu" };
      }

      function showView(route) {
        if (
          route.view !== "note" &&
          document.getElementById("slide-track").classList.contains("show-note")
        ) {
          saveLunch();
          saveNotes();
        }
        var slideContainer = document.getElementById("slide-container");
        var optionsView = document.getElementById("options-view");
        var slideTrack = document.getElementById("slide-track");
        slideContainer.style.display = route.view === "options" ? "none" : "";
        optionsView.classList.toggle("active", route.view === "options");
        slideTrack.classList.toggle("show-note", route.view === "note");
        slideTrack.classList.toggle("show-past", route.view === "past");
        if (route.view === "menu") {
          renderMenu();
        } else if (route.view === "options") {
          // options is static
        } else if (route.view === "past") {
          renderPastTrackers();
        } else {
          currentKey = route.dateKey;
          state = getDayData(currentKey);
          renderNote(false);
        }
      }

      function renderMenu() {}

      function renderPastTrackers() {
        const data = loadAll();
        const today = todayKey();
        const pastKeys = Object.keys(data)
          .filter(function (k) {
            return k !== today;
          })
          .sort()
          .reverse();
        const listEl = document.getElementById("past-trackers-list");
        if (pastKeys.length === 0) {
          listEl.innerHTML =
            '<li style="color:var(--text-muted);padding:16px 0;font-size:0.95rem;">No past trackers yet.</li>';
        } else {
          listEl.innerHTML = pastKeys
            .map(function (k) {
              const dayData = getDayData(k);
              const sr = dayData.srCounter ?? 0;
              const pu = dayData.puCounter ?? 0;
              const todoCount = Array.isArray(dayData.todos)
                ? dayData.todos.length
                : 0;
              return (
                '<li><a href="#note/' +
                k +
                '" class="past-tracker-card">' +
                '<div class="past-tracker-card-content">' +
                '<p class="past-tracker-card-date">' +
                formatDisplayDate(k) +
                "</p>" +
                '<p class="past-tracker-card-metrics">SR: ' +
                sr +
                " PU: " +
                pu +
                " Todos: " +
                todoCount +
                "</p></div>" +
                '<span class="past-tracker-card-chevron">›</span></a></li>'
              );
            })
            .join("");
        }
      }

      function renderNote(skipLunchInputUpdate) {
        var lunchEl = document.getElementById("lunch-time");
        if (lunchEl && !skipLunchInputUpdate) lunchEl.value = state.lunch || "";
        var notesEl = document.getElementById("notes-input");
        if (notesEl && !skipLunchInputUpdate) notesEl.value = state.notes || "";
        document.getElementById("today-date").textContent =
          formatDisplayDate(currentKey);
        document.getElementById("sr-display").textContent = String(
          state.srCounter ?? 0,
        );
        var puVal = state.puCounter ?? 0;
        document.getElementById("pu-display").textContent = String(puVal);
        document.getElementById("pu-value").value = puVal;

        const listEl = document.getElementById("todo-list");
        listEl.innerHTML = "";
        (state.todos || []).forEach((todo, i) => {
          const row = document.createElement("div");
          row.className = "todo-row";
          row.setAttribute("data-index", String(i));
          row.innerHTML =
            '<button type="button" class="todo-row-delete" data-index="' +
            i +
            '">Delete</button>' +
            '<div class="todo-item' +
            (todo.done ? " done" : "") +
            '">' +
            '<label class="todo-check-label">' +
            '<input type="checkbox" id="t-' +
            i +
            '" ' +
            (todo.done ? "checked" : "") +
            ">" +
            '<span class="todo-check-visual" aria-hidden="true"></span>' +
            '<span class="todo-label-text">' +
            escapeHtml(todo.text) +
            "</span>" +
            "</label>" +
            '<span class="todo-drag-handle" draggable="true" data-index="' +
            i +
            '" aria-label="Reorder">' +
            '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M4 6h16v1.5H4V6zm0 5.5h16V13H4v-1.5zm0 5.5h16V19H4v-1.5z"/></svg>' +
            "</span></div>";
          listEl.appendChild(row);
        });

        listEl.querySelectorAll('input[type="checkbox"]').forEach((cb) => {
          cb.addEventListener("change", function () {
            const i = parseInt(this.id.replace("t-", ""), 10);
            state.todos[i].done = this.checked;
            persistDay(currentKey, state);
            renderNote(true);
          });
        });

        listEl.querySelectorAll(".todo-row-delete").forEach((btn) => {
          btn.addEventListener("click", function (e) {
            e.stopPropagation();
            const i = parseInt(this.getAttribute("data-index"), 10);
            state.todos.splice(i, 1);
            persistDay(currentKey, state);
            renderNote(true);
          });
        });

        setupSwipeToDelete(listEl);
        setupTodoReorder(listEl);
      }

      function setupSwipeToDelete(listEl) {
        var startX = 0,
          startY = 0,
          currentX = 0,
          startOffset = 0,
          sliding = null,
          touchId = null,
          gestureLock = null;
        var DELETE_WIDTH = 80;
        var THRESHOLD = 40;
        var LOCK_THRESHOLD = 12;

        function slideTo(rowEl, offsetPx) {
          var content = rowEl && rowEl.querySelector(".todo-item");
          if (!content) return;
          var tx = Math.max(-DELETE_WIDTH, Math.min(0, offsetPx));
          content.style.transition = "none";
          content.style.transform = "translateX(" + tx + "px)";
        }

        function commitSlide(rowEl, reveal) {
          var content = rowEl && rowEl.querySelector(".todo-item");
          if (!content) return;
          content.style.transition = "";
          if (reveal) {
            rowEl.classList.add("reveal-delete");
            content.style.transform = "translateX(-" + DELETE_WIDTH + "px)";
          } else {
            rowEl.classList.remove("reveal-delete");
            content.style.transform = "translateX(0)";
          }
        }

        function closeAllRevealed() {
          listEl
            .querySelectorAll(".todo-row.reveal-delete")
            .forEach(function (r) {
              commitSlide(r, false);
            });
        }

        function onStart(clientX, clientY, target) {
          if (todoReorderDragging) return;
          var r = target.closest(".todo-row");
          if (!r) return;
          gestureLock = null;
          sliding = r;
          startX = clientX;
          startY = clientY;
          currentX = clientX;
          startOffset = r.classList.contains("reveal-delete")
            ? -DELETE_WIDTH
            : 0;
          var content = r.querySelector(".todo-item");
          if (content) content.style.transition = "none";
        }

        function onMove(clientX) {
          if (!sliding) return;
          currentX = clientX;
          var dx = currentX - startX;
          slideTo(sliding, startOffset + dx);
        }

        function onEnd() {
          if (!sliding) return;
          var content = sliding.querySelector(".todo-item");
          if (content) content.style.transition = "";
          var dx = currentX - startX;
          var finalOffset = startOffset + dx;
          if (finalOffset < -THRESHOLD) commitSlide(sliding, true);
          else commitSlide(sliding, false);
          sliding = null;
          touchId = null;
          gestureLock = null;
        }

        listEl.addEventListener(
          "touchstart",
          function (e) {
            if (
              e.target.closest(".todo-row-delete") ||
              e.target.closest(".todo-drag-handle")
            )
              return;
            var t = e.changedTouches[0] || e.touches[0];
            if (!t) return;
            touchId = t.identifier;
            onStart(t.clientX, t.clientY, e.target);
          },
          { passive: true },
        );
        listEl.addEventListener(
          "touchmove",
          function (e) {
            var t =
              Array.prototype.find.call(e.touches, function (x) {
                return x.identifier === touchId;
              }) ||
              (e.changedTouches && e.changedTouches[0]);
            if (!t || !sliding) return;
            var dx = t.clientX - startX;
            var dy = t.clientY - startY;
            if (gestureLock === null) {
              if (
                Math.abs(dx) > LOCK_THRESHOLD ||
                Math.abs(dy) > LOCK_THRESHOLD
              ) {
                gestureLock = Math.abs(dx) >= Math.abs(dy) ? "swipe" : "scroll";
              }
            }
            if (gestureLock === "swipe") {
              e.preventDefault();
              onMove(t.clientX);
            }
          },
          { passive: false },
        );
        listEl.addEventListener(
          "touchend",
          function (e) {
            var t = e.changedTouches[0];
            if (t && t.identifier === touchId) onEnd();
          },
          { passive: true },
        );
        listEl.addEventListener(
          "touchcancel",
          function (e) {
            var t = e.changedTouches[0];
            if (t && t.identifier === touchId) onEnd();
          },
          { passive: true },
        );

        listEl.addEventListener("mousedown", function (e) {
          if (
            e.button !== 0 ||
            e.target.closest(".todo-row-delete") ||
            e.target.closest(".todo-drag-handle")
          )
            return;
          onStart(e.clientX, e.clientY, e.target);
        });
        document.addEventListener("mousemove", function (e) {
          if (sliding) onMove(e.clientX);
        });
        document.addEventListener("mouseup", function () {
          if (sliding) onEnd();
        });

        document.addEventListener("click", function (e) {
          if (listEl.querySelectorAll(".todo-row.reveal-delete").length === 0)
            return;
          if (e.target.closest(".todo-row-delete")) return;
          closeAllRevealed();
        });
      }

      function setupTodoReorder(listEl) {
        var draggedRow = null;

        listEl.addEventListener("dragstart", function (e) {
          var handle = e.target.closest(".todo-drag-handle");
          if (!handle) return;
          todoReorderDragging = true;
          draggedRow = handle.closest(".todo-row");
          if (draggedRow) draggedRow.classList.add("todo-row-dragging");
          e.dataTransfer.effectAllowed = "move";
          e.dataTransfer.setData(
            "text/plain",
            handle.getAttribute("data-index"),
          );
          e.dataTransfer.setData("application/json", "{}");
        });
        listEl.addEventListener("dragend", function (e) {
          todoReorderDragging = false;
          if (draggedRow && draggedRow.parentNode)
            draggedRow.classList.remove("todo-row-dragging");
          listEl.querySelectorAll(".todo-row").forEach(function (r) {
            r.classList.remove("drag-over");
            r.style.transition = "";
            r.style.transform = "";
          });
          draggedRow = null;
        });
        listEl.addEventListener("dragover", function (e) {
          e.preventDefault();
          e.dataTransfer.dropEffect = "move";
          if (!draggedRow || draggedRow.parentNode !== listEl) return;
          var rowUnder = document.elementFromPoint(e.clientX, e.clientY);
          rowUnder =
            rowUnder && rowUnder.closest ? rowUnder.closest(".todo-row") : null;
          if (
            !rowUnder ||
            rowUnder.parentNode !== listEl ||
            rowUnder === draggedRow
          )
            return;
          var children = listEl.children;
          var rowIndex = Array.prototype.indexOf.call(children, rowUnder);
          var rect = rowUnder.getBoundingClientRect();
          var midY = rect.top + rect.height / 2;
          var dropIndex = e.clientY < midY ? rowIndex : rowIndex + 1;
          var currentIndex = Array.prototype.indexOf.call(children, draggedRow);
          if (dropIndex === currentIndex) return;
          listEl.querySelectorAll(".todo-row").forEach(function (r) {
            r.classList.remove("drag-over");
          });
          rowUnder.classList.add("drag-over");
          var oldRects = new Map();
          for (var i = 0; i < children.length; i++) {
            oldRects.set(children[i], children[i].getBoundingClientRect());
          }
          if (dropIndex >= children.length) {
            listEl.appendChild(draggedRow);
          } else {
            listEl.insertBefore(draggedRow, children[dropIndex]);
          }
          requestAnimationFrame(function () {
            var newChildren = listEl.children;
            for (var j = 0; j < newChildren.length; j++) {
              var node = newChildren[j];
              var oldRect = oldRects.get(node);
              if (!oldRect) continue;
              var newRect = node.getBoundingClientRect();
              var dy = oldRect.top - newRect.top;
              if (Math.abs(dy) < 0.5) continue;
              node.style.transition = "none";
              node.style.transform = "translateY(" + dy + "px)";
            }
            requestAnimationFrame(function () {
              for (var k = 0; k < listEl.children.length; k++) {
                var n = listEl.children[k];
                n.style.transition = "transform 0.25s ease-out";
                n.style.transform = "translateY(0)";
              }
            });
          });
        });
        listEl.addEventListener("drop", function (e) {
          e.preventDefault();
          listEl.querySelectorAll(".todo-row").forEach(function (r) {
            r.classList.remove("drag-over");
          });
          if (!draggedRow) return;
          var children = listEl.children;
          var newOrder = [];
          for (var i = 0; i < children.length; i++) {
            var idx = parseInt(children[i].getAttribute("data-index"), 10);
            if (!isNaN(idx)) newOrder.push(idx);
          }
          if (newOrder.length !== children.length) return;
          state.todos = newOrder.map(function (i) {
            return state.todos[i];
          });
          persistDay(currentKey, state);
          renderNote(true);
        });
      }

      document
        .getElementById("sr-decrement")
        .addEventListener("click", function () {
          var n = (state.srCounter ?? 0) - 1;
          state.srCounter = n < 0 ? 0 : n;
          persistDay(currentKey, state);
          renderNote(true);
        });
      document
        .getElementById("sr-increment")
        .addEventListener("click", function () {
          state.srCounter = (state.srCounter ?? 0) + 1;
          persistDay(currentKey, state);
          renderNote(true);
        });

      function escapeHtml(s) {
        const div = document.createElement("div");
        div.textContent = s;
        return div.innerHTML;
      }

      document
        .getElementById("btn-today")
        .addEventListener("click", function () {
          location.hash = "note";
        });

      document
        .getElementById("back-to-menu")
        .addEventListener("click", function (e) {
          e.preventDefault();
          saveLunch();
          saveNotes();
          location.hash = "menu";
        });

      document
        .getElementById("back-from-options")
        .addEventListener("click", function (e) {
          e.preventDefault();
          location.hash = "menu";
        });

      document
        .getElementById("reset-sr")
        .addEventListener("click", function () {
          const today = todayKey();
          const dayData = getDayData(today);
          dayData.srCounter = 0;
          persistDay(today, dayData);
        });

      function savePu() {
        var el = document.getElementById("pu-value");
        var n = parseInt(el.value, 10);
        if (isNaN(n) || n < 0) n = 0;
        if (n > 100) n = 100;
        state.puCounter = n;
        el.value = n;
        persistDay(currentKey, state);
      }
      document.getElementById("pu-value").addEventListener("change", savePu);
      document.getElementById("pu-value").addEventListener("blur", savePu);
      document
        .getElementById("pu-decrement")
        .addEventListener("click", function () {
          var n = (state.puCounter || 0) - 1;
          state.puCounter = n < 0 ? 0 : n;
          persistDay(currentKey, state);
          renderNote(true);
        });
      document
        .getElementById("pu-increment")
        .addEventListener("click", function () {
          var n = (state.puCounter || 0) + 1;
          state.puCounter = n > 100 ? 100 : n;
          persistDay(currentKey, state);
          renderNote(true);
        });

      // Lunch: save on change, load from main data (like todos)
      function saveLunch() {
        state.lunch = (
          document.getElementById("lunch-time").value || ""
        ).trim();
        persistDay(currentKey, state);
      }
      document
        .getElementById("lunch-time")
        .addEventListener("change", saveLunch);

      function saveNotes() {
        var el = document.getElementById("notes-input");
        if (el) state.notes = (el.value || "").trim();
        persistDay(currentKey, state);
      }
      document
        .getElementById("notes-input")
        .addEventListener("input", saveNotes);
      document
        .getElementById("notes-input")
        .addEventListener("blur", saveNotes);

      document.getElementById("todo-add").addEventListener("click", addTodo);
      document
        .getElementById("todo-input")
        .addEventListener("keydown", function (e) {
          if (e.key === "Enter") {
            e.preventDefault();
            addTodo();
          }
        });

      function addTodo() {
        const input = document.getElementById("todo-input");
        const text = (input.value || "").trim();
        if (!text) return;
        if (!state.todos) state.todos = [];
        state.todos.push({ text: text, done: false });
        input.value = "";
        persistDay(currentKey, state);
        renderNote(true);
      }

      window.addEventListener("hashchange", function () {
        showView(getRoute());
      });
      showView(getRoute());
    </script>
  </body>
</html>
